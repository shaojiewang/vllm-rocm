FROM rocm/pytorch:rocm6.0_ubuntu20.04_py3.9_pytorch_2.1.1
ENV WORKSPACE_DIR=/workspace
RUN mkdir -p $WORKSPACE_DIR
WORKDIR $WORKSPACE_DIR
# Limit arch's so composable kernel doesn't take days to finish
ENV PYTORCH_ROCM_ARCH=gfx90a;gfx942
ARG FA_GFX_ARCHS="gfx90a;gfx942"
RUN apt update && apt install -y sqlite3 libsqlite3-dev libfmt-dev
RUN git clone --recursive https://github.com/ROCmSoftwarePlatform/flash-attention \
    && cd flash-attention \
    && export GPU_ARCHS=${FA_GFX_ARCHS} \
    && python setup.py install
RUN git clone -b develop https://github.com/ROCmSoftwarePlatform/hipBLASLt \
    && export GTest_DIR="/usr/local/lib/cmake/GTest/" \
    && cd hipBLASLt \
    && ./install.sh -idc --architecture 'gfx90a;gfx942' \
    && cd ../ && rm -rf hipBLASLt
RUN sed -i 's/, hipblaslt-dev \(.*\), hipcub-dev/, hipcub-dev/g' /var/lib/dpkg/status
RUN sed -i 's/, hipblaslt \(.*\), hipfft/, hipfft/g' /var/lib/dpkg/status

RUN pip uninstall -y triton
RUN git clone https://github.com/ROCmSoftwarePlatform/triton.git \
    && cd triton/python && pip3 install -e .
ENV MAX_JOBS=32
RUN cd ${WORKSPACE_DIR} \
    && git clone -b exp_bandaid https://github.com/ROCmSoftwarePlatform/rccl \
    && cd rccl && mkdir build && cd build \
    && CXX=/opt/rocm/bin/hipcc cmake -DCMAKE_PREFIX_PATH=/opt/rocm/ .. && make -j

RUN pip install xformers==0.0.23 --no-deps
ADD ./ $WORKSPACE_DIR/vllm

RUN cd vllm \
    && pip install -r requirements-rocm.txt \
    && pip install typing-extensions==4.8.0 \
    && bash patch_xformers.rocm.sh \
    && cd gradlib && python setup.py develop && cd ../ \
    && python setup.py build && python setup.py develop; exit 0

RUN pip install pyarrow Ray pandas==2.0 numpy==1.20.3

RUN git clone https://github.com/ROCmSoftwarePlatform/rocmProfileData.git \
    && cd rocmProfileData && make; make install

WORKDIR /workspace/vllm
